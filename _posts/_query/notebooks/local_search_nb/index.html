



<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local Search Notebook</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <link href="https://unpkg.com/prismjs@1.20.0/themes/prism-okaidia.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/19.1.1/tooltips.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
html {
    padding: 0;
    margin: 0;
}

body{
    font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
    padding: 0;
    margin: 0;
}

footer{
    width: 100%;
	height: 32px;
	font-size: 12px;
	display: flex;
	flex-direction: row;
	justify-content: center;
	gap: 18px;
	align-items: center;
	color: #5d5d5d;
	background: #e9eaeb;
	border-top: 1px solid #c4c5c6;
}

#cookiesManager{
    cursor: pointer;
    color: #485fc7;
}

.page-content {
    display: flex;
    flex-direction: row;
    margin: 0;
    padding: 0;
    overflow: scroll;
    padding: 0;
    margin: 0;
}

header {
    background-color: lightgrey;
    height: 2%;
    padding: 10px;
}

nav {
    padding: 1em;
    min-width: 200px;
}

main {
    flex: 1;
    padding: 0 5em 0 5em;
}

.logotitle {
    font-size: 1.5em;
    font-weight: bold;
    margin: 5px;
}

.number {
    all: unset;
}

.tag.token {
    all: unset;
}

main ul {
    list-style-type: disc;
    padding-left: 30px;
    margin-top: 10px;
}

h1 {
    font-size: 2rem;
    margin-top: 10px;
}

h2 {
    font-size: 1.5rem;
    margin-top: 10px;
    font-weight: 500;
}

h3 {
    font-size: 1rem;
    margin-top: 10px; 
    font-weight: 500;
}
p {
    margin-top: 10px;
}
</style>
    <script type="module" async>import mermaid from "https://unpkg.com/mermaid@10/dist/mermaid.esm.min.mjs";document.addEventListener('DOMContentLoaded', mermaid.initialize({"loadOnSave":true}));</script>
    <script>function showTooltip(o,e){o.trigger.className.includes("tooltipped")||(o.trigger.children[0].className="tooltipped tooltipped-s",o.trigger.children[0].ariaLabel=e)}window.addEventListener("load",()=>{var o=new ClipboardJS(".code-copy");o.on("success",o=>showTooltip(o,"Copied!")),o.on("error",o=>showTooltip(o,"Failed..."))});</script>
<script async src="https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js"></script>

    
    <script src="https://wcpstatic.microsoft.com/mscc/lib/v2/wcp-consent.js" type="text/javascript"></script>
    <script>
        function onConsentChanged(categoryPreferences) {
            console.log("onConsentChanged", categoryPreferences);        
        }

        var siteConsent

        function initialize(){
          var currentYear = new Date().getFullYear()
          document.getElementById("copyright").innerHTML = `©️ ${currentYear} Microsoft`;
          window.WcpConsent && WcpConsent.init("en-US", "cookie-banner", function (err, _siteConsent) {
              if (!err) {
                  siteConsent = _siteConsent;  //siteConsent is used to get the current consent  
              } else {
                  console.log("Error initializing WcpConsent: "+ err);
              }
          }, onConsentChanged, WcpConsent.themes.light);
        }

        addEventListener("DOMContentLoaded", initialize)

        function manageConsent() {
        if(siteConsent.isConsentRequired){
            siteConsent.manageConsent();
        }
    }
    </script>
    
  </head>
  <body>
    <header>
        <div id="cookie-banner"></div>
        <a href="/"><span class="logotitle">GraphRAG</span></a>
    </header>
    <div class="page-content">
        <!-- Sidebar -->
        <aside class="menu">
          <ul class="menu-list">
            <li>
              
<a href="/">Welcome</a>

            </li>

            <!-- Get Started Links -->
            <li>
              
<a href="/_posts/get_started/">Get Started</a>

              
<a href="/_posts/developing/">Developing</a>

            </li>

            <!-- Indexing Links -->
            <li>
                
<a href="/_posts/_index/overview/">Indexing</a>

                <ul><li>
<a href="/_posts/_index/0-architecture/">Architecture</a>
</li><li>
<a href="/_posts/_index/1-default_dataflow/">Dataflow</a>
</li><li>
<a href="/_posts/_index/2-cli/">CLI</a>
</li><li>
                    
<a href="/_posts/_index/_workflows/overview/">Workflows</a>

                    <ul  hidden ><li>
<a href="/_posts/_indexing/_workflows/create_base_document_graph/">create_base_document_graph</a>
</li><li>
<a href="/_posts/_indexing/_workflows/create_base_document_nodes/">create_base_document_nodes</a>
</li><li>
<a href="/_posts/_indexing/_workflows/create_base_documents/">create_base_documents</a>
</li><li>
<a href="/_posts/_indexing/_workflows/create_base_entity_graph/">create_base_entity_graph</a>
</li><li>
<a href="/_posts/_indexing/_workflows/create_base_entity_nodes/">create_base_entity_nodes</a>
</li><li>
<a href="/_posts/_indexing/_workflows/create_base_extracted_entities/">create_base_extracted_entities</a>
</li><li>
<a href="/_posts/_indexing/_workflows/create_base_text_units/">create_base_text_units</a>
</li><li>
<a href="/_posts/_indexing/_workflows/create_final_communities/">create_final_communities</a>
</li><li>
<a href="/_posts/_indexing/_workflows/create_final_community_reports/">create_final_community_reports</a>
</li><li>
<a href="/_posts/_indexing/_workflows/create_final_covariates/">create_final_covariates</a>
</li><li>
<a href="/_posts/_indexing/_workflows/create_final_documents/">create_final_documents</a>
</li><li>
<a href="/_posts/_indexing/_workflows/create_final_entities/">create_final_entities</a>
</li><li>
<a href="/_posts/_indexing/_workflows/create_final_nodes/">create_final_nodes</a>
</li><li>
<a href="/_posts/_indexing/_workflows/create_final_relationships/">create_final_relationships</a>
</li><li>
<a href="/_posts/_indexing/_workflows/create_final_text_units/">create_final_text_units</a>
</li><li>
<a href="/_posts/_indexing/_workflows/create_summarized_entities/">create_summarized_entities</a>
</li><li>
<a href="/_posts/_index/_workflows/create_final_community_reports/">create_final_community_reports</a>
</li><li>
<a href="/_posts/_index/_workflows/create_final_relationships/">create_final_relationships</a>
</li><li>
<a href="/_posts/_index/_workflows/create_summarized_entities/">create_summarized_entities</a>
</li><li>
<a href="/_posts/_index/_workflows/create_base_documents/">create_base_documents</a>
</li><li>
<a href="/_posts/_index/_workflows/create_base_entity_graph/">create_base_entity_graph</a>
</li><li>
<a href="/_posts/_index/_workflows/create_final_communities/">create_final_communities</a>
</li><li>
<a href="/_posts/_index/_workflows/create_final_covariates/">create_final_covariates</a>
</li><li>
<a href="/_posts/_index/_workflows/create_final_documents/">create_final_documents</a>
</li><li>
<a href="/_posts/_index/_workflows/create_final_entities/">create_final_entities</a>
</li><li>
<a href="/_posts/_index/_workflows/create_final_nodes/">create_final_nodes</a>
</li><li>
<a href="/_posts/_index/_workflows/create_base_extracted_entities/">create_base_extracted_entities</a>
</li><li>
<a href="/_posts/_index/_workflows/create_base_text_units/">create_base_text_units</a>
</li><li>
<a href="/_posts/_index/_workflows/create_final_text_units/">create_final_text_units</a>
</li></ul>
                  </li>

                  <li>
                    
<a href="/_posts/_index/_verbs/overview/">Verbs</a>

                    <ul  hidden ><li>
<a href="/_posts/_indexing/_verbs/aggregate/">aggregate</a>
</li><li>
<a href="/_posts/_indexing/_verbs/chunk/">chunk</a>
</li><li>
<a href="/_posts/_indexing/_verbs/cluster_graph/">cluster_graph</a>
</li><li>
<a href="/_posts/_indexing/_verbs/concat/">concat</a>
</li><li>
<a href="/_posts/_indexing/_verbs/create_graph/">create_graph</a>
</li><li>
<a href="/_posts/_indexing/_verbs/genid/">genid</a>
</li><li>
<a href="/_posts/_indexing/_verbs/layout_graph/">layout_graph</a>
</li><li>
<a href="/_posts/_indexing/_verbs/merge/">merge</a>
</li><li>
<a href="/_posts/_indexing/_verbs/merge_graphs/">merge_graphs</a>
</li><li>
<a href="/_posts/_indexing/_verbs/noop/">noop</a>
</li><li>
<a href="/_posts/_indexing/_verbs/spread_json/">spread_json</a>
</li><li>
<a href="/_posts/_indexing/_verbs/text_replace/">text_replace</a>
</li><li>
<a href="/_posts/_indexing/_verbs/text_split/">text_split</a>
</li><li>
<a href="/_posts/_indexing/_verbs/unpack_graph/">unpack_graph</a>
</li><li>
<a href="/_posts/_indexing/_verbs/unzip/">unzip</a>
</li><li>
<a href="/_posts/_indexing/_verbs/zip/">zip</a>
</li><li>
<a href="/_posts/_index/_verbs/genid/">genid</a>
</li><li>
<a href="/_posts/_index/_verbs/spread_json/">spread_json</a>
</li><li>
<a href="/_posts/_index/_verbs/unzip/">unzip</a>
</li><li>
<a href="/_posts/_index/_verbs/zip/">zip</a>
</li><li>
<a href="/_posts/_index/_verbs/aggregate/">aggregate</a>
</li><li>
<a href="/_posts/_index/_verbs/concat/">concat</a>
</li><li>
<a href="/_posts/_index/_verbs/merge/">merge</a>
</li><li>
<a href="/_posts/_index/_verbs/text_split/">text_split</a>
</li><li>
<a href="/_posts/_index/_verbs/chunk/">chunk</a>
</li><li>
<a href="/_posts/_index/_verbs/text_replace/">text_replace</a>
</li><li>
<a href="/_posts/_index/_verbs/create_graph/">create_graph</a>
</li><li>
<a href="/_posts/_index/_verbs/unpack_graph/">unpack_graph</a>
</li><li>
<a href="/_posts/_index/_verbs/layout_graph/">layout_graph</a>
</li><li>
<a href="/_posts/_index/_verbs/merge_graphs/">merge_graphs</a>
</li><li>
<a href="/_posts/_index/_verbs/cluster_graph/">cluster_graph</a>
</li></ul>
                  </li>

                  <li>
                    
<a href="/_posts/_config/overview/">Configuration</a>

                    <ul>
                      <li>
<a href="/_posts/_config/env_vars">Using Env Vars</a>
</li>
                      <li>
<a href="/_posts/_config/json_yaml">Using JSON or YAML</a>
</li>
                      <li>
<a href="/_posts/_config/custom">Fully Custom</a>
</li>
                    </ul>
                  </li>
                </ul>
            </li>
            

            <!-- Query Links -->
            <li>
              
<a href="/_posts/_query/overview/">Query</a>

              <ul><li>
<a href="/_posts/_query/0-global_search/">Global Search</a>
</li><li>
<a href="/_posts/_query/1-local_search/">Local Search</a>
</li><li>
<a href="/_posts/_query/2-question_generation/">Question Generation</a>
</li><li>
<a href="/_posts/_query/3-cli/">CLI</a>
</li><li>
                  
<a href="/_posts/_query/notebooks/overview/">Notebooks</a>

                  <ul>
                    <li>
<a href="/_posts/_query/notebooks/global_search_nb">Global Search</a>
</li>
                    <li>
<a href="/_posts/_query/notebooks/local_search_nb">Local Search</a>
</li>
                  </ul>
                </li>
            </ul>
            </li>
          </ul>
        </aside>

        <!-- Main Content -->
        <main>
            <h1>Local Search Notebook</h1>
            
<div style="position: relative">
  <pre class="language-python"><code id="code-0" class="language-python"><span class="token triple-quoted-string string">"""
Copyright (c) Microsoft Corporation. All rights reserved.
"""</span></code></pre>

  <button class="code-copy "
    data-clipboard-target="#code-0"
    style="position: absolute; top: 7.5px; right: 6px; padding-top: 3px; cursor: pointer; outline: none; opacity: 0.8;" title="Copy">
    <span style="display:inline-block;background:url(https://api.iconify.design/mdi/content-copy.svg) no-repeat center center / contain;width: 16px; height: 16px;" class=""></span>
  </button>
</div>

<div style="position: relative">
  <pre class="language-python"><code id="code-1" class="language-python"><span class="token keyword">import</span> os
<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
<span class="token keyword">import</span> tiktoken
<span class="token keyword">from</span> graphrag<span class="token punctuation">.</span>query<span class="token punctuation">.</span>llm<span class="token punctuation">.</span>oai<span class="token punctuation">.</span>chat_openai <span class="token keyword">import</span> ChatOpenAI
<span class="token keyword">from</span> graphrag<span class="token punctuation">.</span>query<span class="token punctuation">.</span>llm<span class="token punctuation">.</span>oai<span class="token punctuation">.</span>typing <span class="token keyword">import</span> OpenaiApiType
<span class="token keyword">from</span> graphrag<span class="token punctuation">.</span>query<span class="token punctuation">.</span>llm<span class="token punctuation">.</span>oai<span class="token punctuation">.</span>embedding <span class="token keyword">import</span> OpenAIEmbedding
<span class="token keyword">from</span> graphrag<span class="token punctuation">.</span>query<span class="token punctuation">.</span><span class="token builtin">input</span><span class="token punctuation">.</span>loaders<span class="token punctuation">.</span>dfs <span class="token keyword">import</span> <span class="token punctuation">(</span>
    read_community_reports<span class="token punctuation">,</span>
    read_entities<span class="token punctuation">,</span>
    read_relationships<span class="token punctuation">,</span>
    read_covariates<span class="token punctuation">,</span>
    store_entity_semantic_embeddings<span class="token punctuation">,</span>
    read_text_units
<span class="token punctuation">)</span>
<span class="token keyword">from</span> graphrag<span class="token punctuation">.</span>query<span class="token punctuation">.</span>structured_search<span class="token punctuation">.</span>local_search<span class="token punctuation">.</span>mixed_context <span class="token keyword">import</span> LocalSearchMixedContext
<span class="token keyword">from</span> graphrag<span class="token punctuation">.</span>query<span class="token punctuation">.</span>structured_search<span class="token punctuation">.</span>local_search<span class="token punctuation">.</span>search <span class="token keyword">import</span> LocalSearch
<span class="token keyword">from</span> graphrag<span class="token punctuation">.</span>vector_stores<span class="token punctuation">.</span>qdrant <span class="token keyword">import</span> Qdrant
<span class="token keyword">from</span> graphrag<span class="token punctuation">.</span>query<span class="token punctuation">.</span>context_builder<span class="token punctuation">.</span>entity_extraction <span class="token keyword">import</span> EntityVectorStoreKey
<span class="token keyword">from</span> graphrag<span class="token punctuation">.</span>query<span class="token punctuation">.</span><span class="token builtin">input</span><span class="token punctuation">.</span>retrieval<span class="token punctuation">.</span>relationships <span class="token keyword">import</span> calculate_relationship_combined_rank
<span class="token keyword">from</span> graphrag<span class="token punctuation">.</span>query<span class="token punctuation">.</span>context_builder<span class="token punctuation">.</span>conversation_history <span class="token keyword">import</span> ConversationHistory
<span class="token keyword">from</span> graphrag<span class="token punctuation">.</span>query<span class="token punctuation">.</span>question_gen<span class="token punctuation">.</span>local_gen <span class="token keyword">import</span> LocalQuestionGen</code></pre>

  <button class="code-copy "
    data-clipboard-target="#code-1"
    style="position: absolute; top: 7.5px; right: 6px; padding-top: 3px; cursor: pointer; outline: none; opacity: 0.8;" title="Copy">
    <span style="display:inline-block;background:url(https://api.iconify.design/mdi/content-copy.svg) no-repeat center center / contain;width: 16px; height: 16px;" class=""></span>
  </button>
</div>
<h2>Local Search Example</h2>
<p>Local search method generates answers by combining relevant data from the AI-extracted knowledge-graph with text chunks of the raw documents. This method is suitable for questions that require an understanding of specific entities mentioned in the documents (e.g. What are the healing properties of chamomile?).</p>
<h3>Load text units and graph data tables as context for local search</h3>
<ul>
<li>In this test we first load indexing outputs from parquet files to dataframes, then convert these dataframes into collections of data objects aligning with the knowledge model.</li>
</ul>
<h3>Load tables to dataframes</h3>

<div style="position: relative">
  <pre class="language-python"><code id="code-21" class="language-python">INPUT_DIR <span class="token operator">=</span> <span class="token string">"./data"</span>

COMMUNITY_REPORT_TABLE <span class="token operator">=</span> <span class="token string">"create_final_community_reports"</span>
ENTITY_TABLE <span class="token operator">=</span> <span class="token string">"create_final_nodes"</span>
ENTITY_EMBEDDING_TABLE <span class="token operator">=</span> <span class="token string">"create_final_entities"</span>
RELATIONSHIP_TABLE <span class="token operator">=</span> <span class="token string">"create_final_relationships"</span>
COVARIATE_TABLE <span class="token operator">=</span> <span class="token string">"create_final_covariates"</span>
TEXT_UNIT_TABLE <span class="token operator">=</span> <span class="token string">"create_final_text_units"</span>
COMMUNITY_LEVEL <span class="token operator">=</span> <span class="token number">2</span></code></pre>

  <button class="code-copy "
    data-clipboard-target="#code-21"
    style="position: absolute; top: 7.5px; right: 6px; padding-top: 3px; cursor: pointer; outline: none; opacity: 0.8;" title="Copy">
    <span style="display:inline-block;background:url(https://api.iconify.design/mdi/content-copy.svg) no-repeat center center / contain;width: 16px; height: 16px;" class=""></span>
  </button>
</div>
<h4>Read entities</h4>

<div style="position: relative">
  <pre class="language-python"><code id="code-25" class="language-python"><span class="token comment"># read nodes table to get community and degree data</span>
entity_df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_parquet<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>INPUT_DIR<span class="token punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">{</span>ENTITY_TABLE<span class="token punctuation">}</span></span><span class="token string">.parquet"</span></span><span class="token punctuation">)</span>
entity_df <span class="token operator">=</span> entity_df<span class="token punctuation">[</span><span class="token punctuation">(</span>entity_df<span class="token punctuation">.</span><span class="token builtin">type</span><span class="token operator">==</span><span class="token string">"entity"</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>entity_df<span class="token punctuation">.</span>level<span class="token operator">&lt;=</span><span class="token string-interpolation"><span class="token string">f"level_</span><span class="token interpolation"><span class="token punctuation">{</span>COMMUNITY_LEVEL<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">]</span>
entity_df <span class="token operator">=</span> entity_df<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"title"</span><span class="token punctuation">,</span> <span class="token string">"degree"</span><span class="token punctuation">,</span> <span class="token string">"community"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>rename<span class="token punctuation">(</span>columns<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"title"</span><span class="token punctuation">:</span> <span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"degree"</span><span class="token punctuation">:</span> <span class="token string">"rank"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

entity_df<span class="token punctuation">[</span><span class="token string">"community"</span><span class="token punctuation">]</span> <span class="token operator">=</span> entity_df<span class="token punctuation">[</span><span class="token string">"community"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>fillna<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
entity_df<span class="token punctuation">[</span><span class="token string">"community"</span><span class="token punctuation">]</span> <span class="token operator">=</span> entity_df<span class="token punctuation">[</span><span class="token string">"community"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span>
entity_df<span class="token punctuation">[</span><span class="token string">"rank"</span><span class="token punctuation">]</span> <span class="token operator">=</span> entity_df<span class="token punctuation">[</span><span class="token string">"rank"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span>

<span class="token comment"># for duplicate entities, keep the one with the highest community level</span>
entity_df <span class="token operator">=</span> entity_df<span class="token punctuation">.</span>groupby<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"rank"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>agg<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"community"</span><span class="token punctuation">:</span> <span class="token string">"max"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reset_index<span class="token punctuation">(</span><span class="token punctuation">)</span>
entity_df<span class="token punctuation">[</span><span class="token string">'community'</span><span class="token punctuation">]</span> <span class="token operator">=</span> entity_df<span class="token punctuation">[</span><span class="token string">'community'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

entity_embedding_df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_parquet<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>INPUT_DIR<span class="token punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">{</span>ENTITY_EMBEDDING_TABLE<span class="token punctuation">}</span></span><span class="token string">.parquet"</span></span><span class="token punctuation">)</span>
entity_embedding_df <span class="token operator">=</span> entity_embedding_df<span class="token punctuation">[</span>
    <span class="token punctuation">[</span>
        <span class="token string">"id"</span><span class="token punctuation">,</span>
        <span class="token string">"human_readable_id"</span><span class="token punctuation">,</span>
        <span class="token string">"name"</span><span class="token punctuation">,</span>
        <span class="token string">"type"</span><span class="token punctuation">,</span>
        <span class="token string">"description"</span><span class="token punctuation">,</span>
        <span class="token string">"name_embedding"</span><span class="token punctuation">,</span>
        <span class="token string">"description_embedding"</span><span class="token punctuation">,</span>
        <span class="token string">"text_unit_ids"</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">]</span>

entity_df <span class="token operator">=</span> entity_df<span class="token punctuation">.</span>merge<span class="token punctuation">(</span>entity_embedding_df<span class="token punctuation">,</span> on<span class="token operator">=</span><span class="token string">'name'</span><span class="token punctuation">,</span> how<span class="token operator">=</span><span class="token string">'inner'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>drop_duplicates<span class="token punctuation">(</span>subset<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment"># read entity dataframe to knowledge model objects</span>
entities <span class="token operator">=</span> read_entities<span class="token punctuation">(</span>
    df<span class="token operator">=</span>entity_df<span class="token punctuation">,</span>
    id_col<span class="token operator">=</span><span class="token string">"id"</span><span class="token punctuation">,</span>
    title_col<span class="token operator">=</span><span class="token string">"name"</span><span class="token punctuation">,</span>
    type_col<span class="token operator">=</span><span class="token string">"type"</span><span class="token punctuation">,</span>
    short_id_col<span class="token operator">=</span><span class="token string">"human_readable_id"</span><span class="token punctuation">,</span>
    description_col<span class="token operator">=</span><span class="token string">"description"</span><span class="token punctuation">,</span>
    community_col<span class="token operator">=</span><span class="token string">"community"</span><span class="token punctuation">,</span>
    rank_col<span class="token operator">=</span><span class="token string">"rank"</span><span class="token punctuation">,</span>
    name_embedding_col<span class="token operator">=</span><span class="token string">"name_embedding"</span><span class="token punctuation">,</span>
    description_embedding_col<span class="token operator">=</span><span class="token string">"description_embedding"</span><span class="token punctuation">,</span>
    graph_embedding_col<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
    text_unit_ids_col<span class="token operator">=</span><span class="token string">"text_unit_ids"</span><span class="token punctuation">,</span>
    document_ids_col<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>

<span class="token comment"># load description embeddings to an in-memory qdrant vectorstore</span>
<span class="token comment"># to connect to a remote db, specify url and port values.</span>
description_embedding_store <span class="token operator">=</span> Qdrant<span class="token punctuation">(</span>
    collection_name<span class="token operator">=</span><span class="token string">"entity_description_embeddings"</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>
description_embedding_store<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">)</span>
entity_description_embeddings <span class="token operator">=</span> store_entity_semantic_embeddings<span class="token punctuation">(</span>
    entities<span class="token operator">=</span>entities<span class="token punctuation">,</span>
    vectorstore<span class="token operator">=</span>description_embedding_store
<span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Entity count: </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">len</span><span class="token punctuation">(</span>entity_df<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
entity_df<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>

  <button class="code-copy "
    data-clipboard-target="#code-25"
    style="position: absolute; top: 7.5px; right: 6px; padding-top: 3px; cursor: pointer; outline: none; opacity: 0.8;" title="Copy">
    <span style="display:inline-block;background:url(https://api.iconify.design/mdi/content-copy.svg) no-repeat center center / contain;width: 16px; height: 16px;" class=""></span>
  </button>
</div>
<h4>Read relationships</h4>

<div style="position: relative">
  <pre class="language-python"><code id="code-29" class="language-python">relationship_df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_parquet<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>INPUT_DIR<span class="token punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">{</span>RELATIONSHIP_TABLE<span class="token punctuation">}</span></span><span class="token string">.parquet"</span></span><span class="token punctuation">)</span>
<span class="token comment">#relationship_df = relationship_df[relationship_df.raw_level_ == "level_0"]</span>
relationship_df <span class="token operator">=</span> relationship_df<span class="token punctuation">[</span><span class="token punctuation">[</span>
    <span class="token string">"id"</span><span class="token punctuation">,</span>
    <span class="token string">"human_readable_id"</span><span class="token punctuation">,</span>
    <span class="token string">"source"</span><span class="token punctuation">,</span>
    <span class="token string">"target"</span><span class="token punctuation">,</span>
    <span class="token string">"description"</span><span class="token punctuation">,</span>
    <span class="token string">"weight"</span><span class="token punctuation">,</span>
    <span class="token string">"text_unit_ids"</span>
<span class="token punctuation">]</span><span class="token punctuation">]</span>
relationship_df<span class="token punctuation">[</span><span class="token string">"id"</span><span class="token punctuation">]</span> <span class="token operator">=</span> relationship_df<span class="token punctuation">[</span><span class="token string">"id"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">)</span>
relationship_df<span class="token punctuation">[</span><span class="token string">"human_readable_id"</span><span class="token punctuation">]</span> <span class="token operator">=</span> relationship_df<span class="token punctuation">[</span><span class="token string">"human_readable_id"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">)</span>
relationship_df<span class="token punctuation">[</span><span class="token string">"weight"</span><span class="token punctuation">]</span> <span class="token operator">=</span> relationship_df<span class="token punctuation">[</span><span class="token string">"weight"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token builtin">float</span><span class="token punctuation">)</span>
relationship_df<span class="token punctuation">[</span><span class="token string">"text_unit_ids"</span><span class="token punctuation">]</span> <span class="token operator">=</span> relationship_df<span class="token punctuation">[</span><span class="token string">"text_unit_ids"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

relationships <span class="token operator">=</span> read_relationships<span class="token punctuation">(</span>
    df<span class="token operator">=</span>relationship_df<span class="token punctuation">,</span>
    id_col<span class="token operator">=</span><span class="token string">"id"</span><span class="token punctuation">,</span>
    short_id_col<span class="token operator">=</span><span class="token string">"human_readable_id"</span><span class="token punctuation">,</span>
    source_col<span class="token operator">=</span><span class="token string">"source"</span><span class="token punctuation">,</span>
    target_col<span class="token operator">=</span><span class="token string">"target"</span><span class="token punctuation">,</span>
    description_col<span class="token operator">=</span><span class="token string">"description"</span><span class="token punctuation">,</span>
    weight_col<span class="token operator">=</span><span class="token string">"weight"</span><span class="token punctuation">,</span>
    description_embedding_col<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
    text_unit_ids_col<span class="token operator">=</span><span class="token string">"text_unit_ids"</span><span class="token punctuation">,</span>
    document_ids_col<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>
relationships <span class="token operator">=</span> calculate_relationship_combined_rank<span class="token punctuation">(</span>relationships<span class="token operator">=</span>relationships<span class="token punctuation">,</span> entities<span class="token operator">=</span>entities<span class="token punctuation">,</span> ranking_attribute<span class="token operator">=</span><span class="token string">"rank"</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Relationship count: </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">len</span><span class="token punctuation">(</span>relationship_df<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
relationship_df<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>

  <button class="code-copy "
    data-clipboard-target="#code-29"
    style="position: absolute; top: 7.5px; right: 6px; padding-top: 3px; cursor: pointer; outline: none; opacity: 0.8;" title="Copy">
    <span style="display:inline-block;background:url(https://api.iconify.design/mdi/content-copy.svg) no-repeat center center / contain;width: 16px; height: 16px;" class=""></span>
  </button>
</div>

<div style="position: relative">
  <pre class="language-python"><code id="code-30" class="language-python"><span class="token keyword">try</span><span class="token punctuation">:</span>
        covariate_df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_parquet<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>INPUT_DIR<span class="token punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">{</span>COVARIATE_TABLE<span class="token punctuation">}</span></span><span class="token string">.parquet"</span></span><span class="token punctuation">)</span>
        covariate_df <span class="token operator">=</span> covariate_df<span class="token punctuation">[</span>
                <span class="token punctuation">[</span>
                        <span class="token string">"id"</span><span class="token punctuation">,</span>
                        <span class="token string">"human_readable_id"</span><span class="token punctuation">,</span>
                        <span class="token string">"type"</span><span class="token punctuation">,</span>
                        <span class="token string">"subject_id"</span><span class="token punctuation">,</span>
                        <span class="token string">"subject_type"</span><span class="token punctuation">,</span>
                        <span class="token string">"object_id"</span><span class="token punctuation">,</span>
                        <span class="token string">"status"</span><span class="token punctuation">,</span>
                        <span class="token string">"start_date"</span><span class="token punctuation">,</span>
                        <span class="token string">"end_date"</span><span class="token punctuation">,</span>
                        <span class="token string">"description"</span>
                <span class="token punctuation">]</span>
        <span class="token punctuation">]</span>

<span class="token keyword">except</span><span class="token punctuation">:</span>
        columns <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token string">'human_readable_id'</span><span class="token punctuation">,</span> <span class="token string">'type'</span><span class="token punctuation">,</span> <span class="token string">'subject_id'</span><span class="token punctuation">,</span> <span class="token string">'object_id'</span><span class="token punctuation">,</span> <span class="token string">'status'</span><span class="token punctuation">,</span> <span class="token string">'start_date'</span><span class="token punctuation">,</span> <span class="token string">'end_date'</span><span class="token punctuation">,</span> <span class="token string">'description'</span><span class="token punctuation">]</span>
        covariate_df <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>data<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> columns<span class="token operator">=</span>columns<span class="token punctuation">)</span>
covariate_df<span class="token punctuation">[</span><span class="token string">"id"</span><span class="token punctuation">]</span> <span class="token operator">=</span> covariate_df<span class="token punctuation">[</span><span class="token string">"id"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">)</span>
covariate_df<span class="token punctuation">[</span><span class="token string">"human_readable_id"</span><span class="token punctuation">]</span> <span class="token operator">=</span> covariate_df<span class="token punctuation">[</span><span class="token string">"human_readable_id"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">)</span>

claims <span class="token operator">=</span> read_covariates<span class="token punctuation">(</span>
        df<span class="token operator">=</span>covariate_df<span class="token punctuation">,</span>
        id_col<span class="token operator">=</span><span class="token string">"id"</span><span class="token punctuation">,</span>
        short_id_col<span class="token operator">=</span><span class="token string">"human_readable_id"</span><span class="token punctuation">,</span>
        subject_col<span class="token operator">=</span><span class="token string">"subject_id"</span><span class="token punctuation">,</span>
        subject_type_col<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
        covariate_type_col<span class="token operator">=</span><span class="token string">"type"</span><span class="token punctuation">,</span>
        attributes_cols<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"object_id"</span><span class="token punctuation">,</span><span class="token string">"status"</span><span class="token punctuation">,</span> <span class="token string">"start_date"</span><span class="token punctuation">,</span> <span class="token string">"end_date"</span><span class="token punctuation">,</span> <span class="token string">"description"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        text_unit_ids_col<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
        document_ids_col<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Claim records: </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">len</span><span class="token punctuation">(</span>claims<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
covariates <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'claims'</span><span class="token punctuation">:</span> claims<span class="token punctuation">}</span>
</code></pre>

  <button class="code-copy "
    data-clipboard-target="#code-30"
    style="position: absolute; top: 7.5px; right: 6px; padding-top: 3px; cursor: pointer; outline: none; opacity: 0.8;" title="Copy">
    <span style="display:inline-block;background:url(https://api.iconify.design/mdi/content-copy.svg) no-repeat center center / contain;width: 16px; height: 16px;" class=""></span>
  </button>
</div>
<h4>Read community reports</h4>

<div style="position: relative">
  <pre class="language-python"><code id="code-34" class="language-python"><span class="token comment"># get a list of communities from entity table</span>
community_df <span class="token operator">=</span> entity_df<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"community"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>
community_df<span class="token punctuation">[</span><span class="token string">"community_id"</span><span class="token punctuation">]</span> <span class="token operator">=</span> community_df<span class="token punctuation">[</span><span class="token string">"community"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
community_df <span class="token operator">=</span> community_df<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"community_id"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>drop_duplicates<span class="token punctuation">(</span>subset<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'community_id'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Community records: </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">len</span><span class="token punctuation">(</span>community_df<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span></code></pre>

  <button class="code-copy "
    data-clipboard-target="#code-34"
    style="position: absolute; top: 7.5px; right: 6px; padding-top: 3px; cursor: pointer; outline: none; opacity: 0.8;" title="Copy">
    <span style="display:inline-block;background:url(https://api.iconify.design/mdi/content-copy.svg) no-repeat center center / contain;width: 16px; height: 16px;" class=""></span>
  </button>
</div>

<div style="position: relative">
  <pre class="language-python"><code id="code-35" class="language-python">report_df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_parquet<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>INPUT_DIR<span class="token punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">{</span>COMMUNITY_REPORT_TABLE<span class="token punctuation">}</span></span><span class="token string">.parquet"</span></span><span class="token punctuation">)</span>
report_df <span class="token operator">=</span> report_df<span class="token punctuation">[</span>report_df<span class="token punctuation">.</span>level <span class="token operator">&lt;=</span> <span class="token string-interpolation"><span class="token string">f"level_</span><span class="token interpolation"><span class="token punctuation">{</span>COMMUNITY_LEVEL<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">]</span>
report_df <span class="token operator">=</span> report_df<span class="token punctuation">.</span>merge<span class="token punctuation">(</span>community_df<span class="token punctuation">,</span> on<span class="token operator">=</span><span class="token string">'community_id'</span><span class="token punctuation">,</span> how<span class="token operator">=</span><span class="token string">'inner'</span><span class="token punctuation">)</span>
report_df<span class="token punctuation">[</span><span class="token string">"rank"</span><span class="token punctuation">]</span> <span class="token operator">=</span> report_df<span class="token punctuation">[</span><span class="token string">"rank"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span>

reports <span class="token operator">=</span> read_community_reports<span class="token punctuation">(</span>
    df<span class="token operator">=</span>report_df<span class="token punctuation">,</span>
    id_col<span class="token operator">=</span><span class="token string">"community_id"</span><span class="token punctuation">,</span>
    short_id_col<span class="token operator">=</span><span class="token string">"community_id"</span><span class="token punctuation">,</span>
    community_col<span class="token operator">=</span><span class="token string">"community_id"</span><span class="token punctuation">,</span>
    title_col<span class="token operator">=</span><span class="token string">"title"</span><span class="token punctuation">,</span>
    summary_col<span class="token operator">=</span><span class="token string">"summary"</span><span class="token punctuation">,</span>
    content_col<span class="token operator">=</span><span class="token string">"full_content"</span><span class="token punctuation">,</span>
    rank_col<span class="token operator">=</span><span class="token string">"rank"</span><span class="token punctuation">,</span>
    summary_embedding_col<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
    content_embedding_col<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Report records: </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">len</span><span class="token punctuation">(</span>report_df<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
report_df<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>

  <button class="code-copy "
    data-clipboard-target="#code-35"
    style="position: absolute; top: 7.5px; right: 6px; padding-top: 3px; cursor: pointer; outline: none; opacity: 0.8;" title="Copy">
    <span style="display:inline-block;background:url(https://api.iconify.design/mdi/content-copy.svg) no-repeat center center / contain;width: 16px; height: 16px;" class=""></span>
  </button>
</div>
<h4>Read text units</h4>

<div style="position: relative">
  <pre class="language-python"><code id="code-39" class="language-python">text_unit_df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_parquet<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>INPUT_DIR<span class="token punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">{</span>TEXT_UNIT_TABLE<span class="token punctuation">}</span></span><span class="token string">.parquet"</span></span><span class="token punctuation">)</span>

text_units <span class="token operator">=</span> read_text_units<span class="token punctuation">(</span>
    df<span class="token operator">=</span>text_unit_df<span class="token punctuation">,</span>
    id_col<span class="token operator">=</span><span class="token string">"id"</span><span class="token punctuation">,</span>
    short_id_col<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
    text_col<span class="token operator">=</span><span class="token string">"text"</span><span class="token punctuation">,</span>
    embedding_col<span class="token operator">=</span><span class="token string">"text_embedding"</span><span class="token punctuation">,</span>
    entities_col<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
    relationships_col<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
    covariates_col<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>

<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Text unit records: </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">len</span><span class="token punctuation">(</span>text_unit_df<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
text_unit_df<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>

  <button class="code-copy "
    data-clipboard-target="#code-39"
    style="position: absolute; top: 7.5px; right: 6px; padding-top: 3px; cursor: pointer; outline: none; opacity: 0.8;" title="Copy">
    <span style="display:inline-block;background:url(https://api.iconify.design/mdi/content-copy.svg) no-repeat center center / contain;width: 16px; height: 16px;" class=""></span>
  </button>
</div>

<div style="position: relative">
  <pre class="language-python"><code id="code-40" class="language-python">api_key <span class="token operator">=</span> <span class="token string">"&lt;api_key>"</span>
api_version <span class="token operator">=</span> <span class="token string">"api_version"</span>
llm_model <span class="token operator">=</span> <span class="token string">"model or deployment id"</span>
embedding_model <span class="token operator">=</span> <span class="token string">"model or deployment id"</span>

llm <span class="token operator">=</span> ChatOpenAI<span class="token punctuation">(</span>
    api_key<span class="token operator">=</span>api_key<span class="token punctuation">,</span>
    model<span class="token operator">=</span>llm_model<span class="token punctuation">,</span>
    api_type<span class="token operator">=</span>OpenaiApiType<span class="token punctuation">.</span>OpenAI<span class="token punctuation">,</span> <span class="token comment"># OpenaiApiType.OpenAI or OpenaiApiType.AzureOpenAI</span>
    api_version<span class="token operator">=</span>api_version<span class="token punctuation">,</span>
    max_retries<span class="token operator">=</span><span class="token number">20</span>
<span class="token punctuation">)</span>

token_encoder <span class="token operator">=</span> tiktoken<span class="token punctuation">.</span>get_encoding<span class="token punctuation">(</span><span class="token string">"cl100k_base"</span><span class="token punctuation">)</span>

text_embedder <span class="token operator">=</span> OpenAIEmbedding<span class="token punctuation">(</span>
    api_key<span class="token operator">=</span>api_key<span class="token punctuation">,</span>
    api_base<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
    api_type<span class="token operator">=</span>OpenaiApiType<span class="token punctuation">.</span>OpenAI<span class="token punctuation">,</span>
    model<span class="token operator">=</span>embedding_model<span class="token punctuation">,</span>
    deployment_name<span class="token operator">=</span>embedding_model<span class="token punctuation">,</span>
    api_version<span class="token operator">=</span>api_version<span class="token punctuation">,</span>
    max_retries<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span></code></pre>

  <button class="code-copy "
    data-clipboard-target="#code-40"
    style="position: absolute; top: 7.5px; right: 6px; padding-top: 3px; cursor: pointer; outline: none; opacity: 0.8;" title="Copy">
    <span style="display:inline-block;background:url(https://api.iconify.design/mdi/content-copy.svg) no-repeat center center / contain;width: 16px; height: 16px;" class=""></span>
  </button>
</div>
<h3>Create local search context builder</h3>

<div style="position: relative">
  <pre class="language-python"><code id="code-44" class="language-python">context_builder <span class="token operator">=</span> LocalSearchMixedContext<span class="token punctuation">(</span>
    community_reports<span class="token operator">=</span>reports<span class="token punctuation">,</span>
    text_units<span class="token operator">=</span>text_units<span class="token punctuation">,</span>
    entities<span class="token operator">=</span>entities<span class="token punctuation">,</span>
    relationships<span class="token operator">=</span>relationships<span class="token punctuation">,</span>
    covariates<span class="token operator">=</span>covariates<span class="token punctuation">,</span>
    entity_text_embeddings<span class="token operator">=</span>description_embedding_store<span class="token punctuation">,</span>
    embedding_vectorstore_key<span class="token operator">=</span>EntityVectorStoreKey<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> <span class="token comment"># if the vectorstore uses entity title as ids, set this to EntityVectorStoreKey.TITLE</span>
    text_embedder<span class="token operator">=</span>text_embedder<span class="token punctuation">,</span>
    token_encoder<span class="token operator">=</span>token_encoder<span class="token punctuation">,</span>
<span class="token punctuation">)</span></code></pre>

  <button class="code-copy "
    data-clipboard-target="#code-44"
    style="position: absolute; top: 7.5px; right: 6px; padding-top: 3px; cursor: pointer; outline: none; opacity: 0.8;" title="Copy">
    <span style="display:inline-block;background:url(https://api.iconify.design/mdi/content-copy.svg) no-repeat center center / contain;width: 16px; height: 16px;" class=""></span>
  </button>
</div>
<h3>Create local search engine</h3>

<div style="position: relative">
  <pre class="language-python"><code id="code-48" class="language-python">
<span class="token comment"># text_unit_prop: proportion of context window dedicated to related text units</span>
<span class="token comment"># community_prop: proportion of context window dedicated to community reports.</span>
<span class="token comment"># The remaining proportion is dedicated to entities and relationships. Sum of text_unit_prop and community_prop should be &lt;= 1</span>
<span class="token comment"># conversation_history_max_turns: maximum number of turns to include in the conversation history.</span>
<span class="token comment"># conversation_history_user_turns_only: if True, only include user queries in the conversation history.</span>
<span class="token comment"># top_k_mapped_entities: number of related entities to retrieve from the entity description embedding store.</span>
<span class="token comment"># top_k_relationships: control the number of out-of-network relationships to pull into the context window.</span>
<span class="token comment"># include_entity_rank: if True, include the entity rank in the entity table in the context window. Default entity rank = node degree.</span>
<span class="token comment"># include_relationship_weight: if True, include the relationship weight in the context window.</span>
<span class="token comment"># include_community_rank: if True, include the community rank in the context window.</span>
<span class="token comment"># return_candidate_context: if True, return a set of dataframes containing all candidate entity/relationship/covariate records that</span>
<span class="token comment"># could be relevant. Note that not all of these records will be included in the context window. The "in_context" column in these</span>
<span class="token comment"># dataframes indicates whether the record is included in the context window.</span>
<span class="token comment"># max_tokens: maximum number of tokens to use for the context window.</span>


local_context_params <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">"text_unit_prop"</span><span class="token punctuation">:</span> <span class="token number">0.5</span><span class="token punctuation">,</span>
    <span class="token string">"community_prop"</span><span class="token punctuation">:</span> <span class="token number">0.1</span><span class="token punctuation">,</span>
    <span class="token string">"conversation_history_max_turns"</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
    <span class="token string">"conversation_history_user_turns_only"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
    <span class="token string">"top_k_mapped_entities"</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
    <span class="token string">"top_k_relationships"</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
    <span class="token string">"include_entity_rank"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
    <span class="token string">"include_relationship_weight"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
    <span class="token string">"include_community_rank"</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span>
    <span class="token string">"return_candidate_context"</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span>
    <span class="token string">"embedding_vectorstore_key"</span><span class="token punctuation">:</span> EntityVectorStoreKey<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> <span class="token comment"># set this to EntityVectorStoreKey.TITLE if the vectorstore uses entity title as ids</span>
    <span class="token string">"max_tokens"</span><span class="token punctuation">:</span> <span class="token number">16000</span> <span class="token comment"># change this based on the token limit you have on your model (if you are using a model with 8k limit, a good setting could be 5000)</span>
<span class="token punctuation">}</span>

llm_params <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">"max_tokens"</span><span class="token punctuation">:</span> <span class="token number">2000</span><span class="token punctuation">,</span> <span class="token comment"># change this based on the token limit you have on your model (if you are using a model with 8k limit, a good setting could be 1000=1500)</span>
    <span class="token string">"temperature"</span><span class="token punctuation">:</span> <span class="token number">0.0</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span></code></pre>

  <button class="code-copy "
    data-clipboard-target="#code-48"
    style="position: absolute; top: 7.5px; right: 6px; padding-top: 3px; cursor: pointer; outline: none; opacity: 0.8;" title="Copy">
    <span style="display:inline-block;background:url(https://api.iconify.design/mdi/content-copy.svg) no-repeat center center / contain;width: 16px; height: 16px;" class=""></span>
  </button>
</div>

<div style="position: relative">
  <pre class="language-python"><code id="code-49" class="language-python">search_engine <span class="token operator">=</span> LocalSearch<span class="token punctuation">(</span>
    llm<span class="token operator">=</span>llm<span class="token punctuation">,</span>
    context_builder<span class="token operator">=</span>context_builder<span class="token punctuation">,</span>
    token_encoder<span class="token operator">=</span>token_encoder<span class="token punctuation">,</span>
    llm_params<span class="token operator">=</span>llm_params<span class="token punctuation">,</span>
    context_builder_params<span class="token operator">=</span>local_context_params<span class="token punctuation">,</span>
    response_type<span class="token operator">=</span><span class="token string">"multiple paragraphs"</span> <span class="token comment"># free form text describing the response type and format, can be anything, e.g. prioritized list, single paragraph, multiple paragraphs, multiple-page report</span>
<span class="token punctuation">)</span></code></pre>

  <button class="code-copy "
    data-clipboard-target="#code-49"
    style="position: absolute; top: 7.5px; right: 6px; padding-top: 3px; cursor: pointer; outline: none; opacity: 0.8;" title="Copy">
    <span style="display:inline-block;background:url(https://api.iconify.design/mdi/content-copy.svg) no-repeat center center / contain;width: 16px; height: 16px;" class=""></span>
  </button>
</div>
<h3>Run local search on sample queries</h3>

<div style="position: relative">
  <pre class="language-python"><code id="code-53" class="language-python">result <span class="token operator">=</span> <span class="token keyword">await</span> search_engine<span class="token punctuation">.</span>asearch<span class="token punctuation">(</span><span class="token string">'What are the healing properties of chamomile?'</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>response<span class="token punctuation">)</span></code></pre>

  <button class="code-copy "
    data-clipboard-target="#code-53"
    style="position: absolute; top: 7.5px; right: 6px; padding-top: 3px; cursor: pointer; outline: none; opacity: 0.8;" title="Copy">
    <span style="display:inline-block;background:url(https://api.iconify.design/mdi/content-copy.svg) no-repeat center center / contain;width: 16px; height: 16px;" class=""></span>
  </button>
</div>

<div style="position: relative">
  <pre class="language-python"><code id="code-54" class="language-python">question <span class="token operator">=</span> <span class="token string">"When is it better to harvest chamomile?"</span>
result <span class="token operator">=</span> <span class="token keyword">await</span> search_engine<span class="token punctuation">.</span>asearch<span class="token punctuation">(</span>question<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>response<span class="token punctuation">)</span>
</code></pre>

  <button class="code-copy "
    data-clipboard-target="#code-54"
    style="position: absolute; top: 7.5px; right: 6px; padding-top: 3px; cursor: pointer; outline: none; opacity: 0.8;" title="Copy">
    <span style="display:inline-block;background:url(https://api.iconify.design/mdi/content-copy.svg) no-repeat center center / contain;width: 16px; height: 16px;" class=""></span>
  </button>
</div>
<h4>Inspecting the context data used to generate the response</h4>

<div style="position: relative">
  <pre class="language-python"><code id="code-58" class="language-python">result<span class="token punctuation">.</span>context_data<span class="token punctuation">[</span><span class="token string">'entities'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>

  <button class="code-copy "
    data-clipboard-target="#code-58"
    style="position: absolute; top: 7.5px; right: 6px; padding-top: 3px; cursor: pointer; outline: none; opacity: 0.8;" title="Copy">
    <span style="display:inline-block;background:url(https://api.iconify.design/mdi/content-copy.svg) no-repeat center center / contain;width: 16px; height: 16px;" class=""></span>
  </button>
</div>

<div style="position: relative">
  <pre class="language-python"><code id="code-59" class="language-python">result<span class="token punctuation">.</span>context_data<span class="token punctuation">[</span><span class="token string">'relationships'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>

  <button class="code-copy "
    data-clipboard-target="#code-59"
    style="position: absolute; top: 7.5px; right: 6px; padding-top: 3px; cursor: pointer; outline: none; opacity: 0.8;" title="Copy">
    <span style="display:inline-block;background:url(https://api.iconify.design/mdi/content-copy.svg) no-repeat center center / contain;width: 16px; height: 16px;" class=""></span>
  </button>
</div>

<div style="position: relative">
  <pre class="language-python"><code id="code-60" class="language-python">result<span class="token punctuation">.</span>context_data<span class="token punctuation">[</span><span class="token string">'reports'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>

  <button class="code-copy "
    data-clipboard-target="#code-60"
    style="position: absolute; top: 7.5px; right: 6px; padding-top: 3px; cursor: pointer; outline: none; opacity: 0.8;" title="Copy">
    <span style="display:inline-block;background:url(https://api.iconify.design/mdi/content-copy.svg) no-repeat center center / contain;width: 16px; height: 16px;" class=""></span>
  </button>
</div>

<div style="position: relative">
  <pre class="language-python"><code id="code-61" class="language-python">result<span class="token punctuation">.</span>context_data<span class="token punctuation">[</span><span class="token string">'sources'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>

  <button class="code-copy "
    data-clipboard-target="#code-61"
    style="position: absolute; top: 7.5px; right: 6px; padding-top: 3px; cursor: pointer; outline: none; opacity: 0.8;" title="Copy">
    <span style="display:inline-block;background:url(https://api.iconify.design/mdi/content-copy.svg) no-repeat center center / contain;width: 16px; height: 16px;" class=""></span>
  </button>
</div>
<h3>Question Generation</h3>
<p>This function takes a list of user queries and generates the next candidate questions.</p>

<div style="position: relative">
  <pre class="language-python"><code id="code-68" class="language-python">question_generator <span class="token operator">=</span> LocalQuestionGen<span class="token punctuation">(</span>
    llm<span class="token operator">=</span>llm<span class="token punctuation">,</span>
    context_builder<span class="token operator">=</span>context_builder<span class="token punctuation">,</span>
    token_encoder<span class="token operator">=</span>token_encoder<span class="token punctuation">,</span>
    llm_params<span class="token operator">=</span>llm_params<span class="token punctuation">,</span>
    context_builder_params<span class="token operator">=</span>local_context_params<span class="token punctuation">,</span>
<span class="token punctuation">)</span></code></pre>

  <button class="code-copy "
    data-clipboard-target="#code-68"
    style="position: absolute; top: 7.5px; right: 6px; padding-top: 3px; cursor: pointer; outline: none; opacity: 0.8;" title="Copy">
    <span style="display:inline-block;background:url(https://api.iconify.design/mdi/content-copy.svg) no-repeat center center / contain;width: 16px; height: 16px;" class=""></span>
  </button>
</div>

<div style="position: relative">
  <pre class="language-python"><code id="code-69" class="language-python">question_history <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">"Tell me about chamomile"</span><span class="token punctuation">,</span>
    <span class="token string">"what is its role in herbal medicine?"</span>
<span class="token punctuation">]</span>
candidate_questions <span class="token operator">=</span> <span class="token keyword">await</span> question_generator<span class="token punctuation">.</span>agenerate<span class="token punctuation">(</span>
    question_history<span class="token operator">=</span>question_history<span class="token punctuation">,</span>
    context_data<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
    question_count<span class="token operator">=</span><span class="token number">5</span>
<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>candidate_questions<span class="token punctuation">.</span>response<span class="token punctuation">)</span></code></pre>

  <button class="code-copy "
    data-clipboard-target="#code-69"
    style="position: absolute; top: 7.5px; right: 6px; padding-top: 3px; cursor: pointer; outline: none; opacity: 0.8;" title="Copy">
    <span style="display:inline-block;background:url(https://api.iconify.design/mdi/content-copy.svg) no-repeat center center / contain;width: 16px; height: 16px;" class=""></span>
  </button>
</div>

        </main>
    </div>
    <footer>
      <a href="https://go.microsoft.com/fwlink/?LinkId=521839">Privacy</a>
      |
      <a href="https://go.microsoft.com/fwlink/?LinkId=2259814">Consumer Health Privacy</a>
      |
      <span id="cookiesManager" onClick="manageConsent();">Cookies</span>
      |
      <a href="https://go.microsoft.com/fwlink/?LinkID=206977">Terms of Use</a>
      |
      <a href="https://www.microsoft.com/trademarks">Trademarks</a>
      |
      <a href="https://www.microsoft.com" id="copyright"></a>
      |
      <a href="https://github.com/microsoft/graphrag">GitHub</a>
    </footer>    
  </body>
</html>